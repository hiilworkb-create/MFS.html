<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Wizard · Telegram Mini App</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root{
      --bg: var(--tg-theme-bg-color, #0f1115);
      --card:#141820;
      --text: var(--tg-theme-text-color, #e5e7eb);
      --muted: var(--tg-theme-hint-color, #9aa4b2);
      --accent: var(--tg-theme-button-color, #3b82f6);
      --accent-text: var(--tg-theme-button-text-color, #fff);
      --danger:#ef4444;
      --ok:#22c55e;
      --border:#212836;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu;}
    .wrap{max-width:860px;margin:0 auto;padding:20px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:0 8px 24px rgba(0,0,0,.25);padding:20px}
    h1{font-size:20px;margin:0 0 12px}
    .steps{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:12px}
    .step{padding:6px 10px;border-radius:999px;border:1px solid var(--border);color:var(--muted);opacity:.8}
    .step.active{background:var(--accent);color:var(--accent-text);border-color:transparent;opacity:1}
    label{display:block;margin:14px 0 6px}
    input,textarea,select{
      width:100%;background:#0b0f15;border:1px solid var(--border);color:var(--text);
      border-radius:10px;padding:12px;outline:none;
    }
    input:focus,textarea:focus{border-color:#2f7bff}
    small.err{display:block;color:var(--danger);min-height:1.2em;margin-top:6px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .row-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
    .controls{display:flex;gap:10px;margin-top:16px}
    .btn{appearance:none;border:1px solid var(--border);background:#0b0f15;color:var(--text);padding:12px 14px;border-radius:12px;cursor:pointer}
    .btn.primary{background:var(--accent);color:var(--accent-text);border-color:transparent}
    .muted{color:var(--muted)}
    .hint{font-size:13px;color:var(--muted)}
    .ok{color:var(--ok)}
    .hidden{display:none}
    footer{margin-top:14px;font-size:12px;color:var(--muted)}
    .preview{white-space:pre-wrap;background:#0b0f15;border:1px dashed var(--border);padding:12px;border-radius:12px;margin-top:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Мастер оформления</h1>
      <div id="steps" class="steps"></div>

      <!-- Шаг 1 -->
      <section class="page" data-step="1">
        <label>ФИО</label>
        <input id="fullname" placeholder="Иванов Иван Иванович"/>
        <small id="err-fullname" class="err"></small>
      </section>

      <!-- Шаг 2 -->
      <section class="page hidden" data-step="2">
        <div class="row">
          <div>
            <label>Телефон</label>
            <input id="phone" placeholder="+7 999 123-45-67"/>
            <small id="err-phone" class="err"></small>
          </div>
          <div>
            <label class="muted">Комментарий (необязательно)</label>
            <input id="note" placeholder="Любая пометка"/>
          </div>
        </div>
      </section>

      <!-- Шаг 3 -->
      <section class="page hidden" data-step="3">
        <label>Адрес</label>
        <input id="address" placeholder="Город, улица, дом, кв."/>
        <small id="err-address" class="err"></small>
      </section>

      <!-- Шаг 4 -->
      <section class="page hidden" data-step="4">
        <div class="row">
          <div>
            <label>Документы (можно несколько)</label>
            <input id="documents" type="file" multiple/>
            <div class="hint">Допустимы любые популярные форматы (PDF/JPG/PNG/HEIC/WEBP/DOC/DOCX и т.д.). Можно ничего не прикреплять — шаг всё равно пройдёт.</div>
            <small id="err-doc" class="err"></small>
          </div>
          <div>
            <label>Номер документа (если удобнее текстом)</label>
            <input id="doc-number" placeholder="серия и номер / иной идентификатор"/>
          </div>
        </div>
      </section>

      <!-- Шаг 5 -->
      <section class="page hidden" data-step="5">
        <div class="row">
          <div>
            <label>Код подтверждения (опционально)</label>
            <input id="code" placeholder="XXXX-XXXX"/>
            <small id="err-code" class="err"></small>
          </div>
          <div>
            <label class="muted">Проверка</label>
            <div class="hint">На финальном шаге данные отправятся боту и в Google Sheets.</div>
          </div>
        </div>
        <div id="browserPreview" class="preview hidden"></div>
      </section>

      <div class="controls">
        <button id="backBtn" class="btn">Назад</button>
        <button id="nextBtn" class="btn primary">Далее</button>
      </div>
      <footer>Если открыто вне Telegram — появится JSON-превью вместо отправки.</footer>
    </div>
  </div>

<script>
(() => {
  // ==== настройки ====
  const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/PASTE_YOUR_DEPLOYED_APPS_SCRIPT_URL/exec'; // ← замените
  const SHEET_SOURCE_TAG = 'miniapp'; // пометка в таблицу

  // ==== Telegram SDK fallback ====
  const tg = (window.Telegram && window.Telegram.WebApp) ? window.Telegram.WebApp : {
    initData: '',
    initDataUnsafe: {},
    isExpanded: true,
    MainButton: {
      text:'', setText(t){this.text=t},
      show(){}, hide(){}, onClick(){}, offClick(){},
      showProgress(){}, hideProgress(){},
      isVisible:false
    },
    HapticFeedback:{impactOccurred(){}},
    ready(){},
    close() {}
  };

  tg.ready();

  // ==== состояние мастера ====
  const pages = [...document.querySelectorAll('.page')];
  let current = 1;
  const stepsBar = document.getElementById('steps');

  const renderSteps = () => {
    stepsBar.innerHTML = '';
    for (let i=1;i<=pages.length;i++){
      const el = document.createElement('div');
      el.className = 'step' + (i===current ? ' active':'');
      el.textContent = `Шаг ${i}`;
      stepsBar.appendChild(el);
    }
    pages.forEach(p => p.classList.toggle('hidden', +p.dataset.step !== current));
    document.getElementById('backBtn').disabled = current === 1;
    document.getElementById('nextBtn').textContent = (current===pages.length) ? 'Отправить' : 'Далее';
    if (current===pages.length){
      tg.MainButton.setText('Отправить');
      tg.MainButton.show?.();
    } else {
      tg.MainButton.hide?.();
    }
  };

  // ==== утилиты ====
  const $id = (id) => document.getElementById(id);
  const val = (id) => ($id(id)?.value || '').trim();
  const clearErrs = () => ['err-fullname','err-phone','err-address','err-doc','err-code'].forEach(id => $id(id).textContent = '');

  const hasMin = (s,n)=> s.replace(/\s+/g,' ').trim().length >= n;
  const digits = (s)=> (s||'').replace(/\D+/g,'');
  const phoneOk = (s) => { const d = digits(s); return d.length>=10 && d.length<=15; };
  const streetOk = (s)=> hasMin(s,5);
  const codeOk = (s)=> !s || /^[A-Za-z0-9\-\s]{4,}$/.test(s);

  const docsPass = () => {
    const fi = $id('documents');
    const textual = val('doc-number');
    if (fi && fi.files && fi.files.length){
      // максимально лояльно
      return true;
    }
    if (textual && textual.length>=4) return true;
    $id('err-doc').textContent = 'Документы не прикреплены — пропускаю по упрощённой проверке.';
    return true;
  };

  const validate = (step) => {
    clearErrs();
    switch(step){
      case 1: return hasMin(val('fullname'),2) || ( $id('err-fullname').textContent='Укажите ФИО (мин. 2 символа)', false);
      case 2: return phoneOk(val('phone')) || ( $id('err-phone').textContent='Введите номер (10–15 цифр, формат свободный)', false);
      case 3: return streetOk(val('address')) || ( $id('err-address').textContent='Укажите адрес (мин. 5 символов)', false);
      case 4: return docsPass();
      case 5: return codeOk(val('code')) || ( $id('err-code').textContent='Неверный формат кода', false);
      default: return true;
    }
  };

  const filesToMeta = (fileList) => {
    if (!fileList || !fileList.length) return [];
    return [...fileList].map(f => ({name:f.name, size:f.size, type:f.type}));
  };

  const buildPayload = () => {
    const fi = $id('documents');
    return {
      source: SHEET_SOURCE_TAG,
      tg_init_data: tg.initData || '',
      tg_user: tg.initDataUnsafe?.user || null,
      fullname: val('fullname'),
      phone: val('phone'),
      note: val('note'),
      address: val('address'),
      doc_number: val('doc-number'),
      code: val('code'),
      files: filesToMeta(fi?.files),
      ua: navigator.userAgent,
    };
  };

  async function submit(){
    const data = buildPayload();

    // если не в Telegram — показываем превью и не отправляем
    const inTelegram = !!(window.Telegram && window.Telegram.WebApp && (window.Telegram.WebApp.platform || window.Telegram.WebApp.initData));
    if (!inTelegram){
      const box = $id('browserPreview');
      box.classList.remove('hidden');
      box.textContent = JSON.stringify(data,null,2);
      alert('Открыто вне Telegram — показал превью JSON. В Telegram данные уйдут в Google Sheets.');
      return;
    }

    try{
      tg.MainButton.showProgress?.();
      const res = await fetch(APPS_SCRIPT_URL, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(data)
      });
      const json = await res.json();
      if (!res.ok || !json.ok) throw new Error(json.error || 'Server error');
      tg.HapticFeedback?.impactOccurred('soft');
      // отправим также в бота (если нужно ловить в on_web_app_data)
      window.Telegram.WebApp.sendData(JSON.stringify({status:'ok', rowId: json.rowId || null}));
      alert('Отправлено! Данные записаны в таблицу.');
      // window.Telegram.WebApp.close(); // включи, если нужно закрывать
    }catch(err){
      alert('Не удалось отправить: '+ err.message);
    }finally{
      tg.MainButton.hideProgress?.();
    }
  }

  // ==== навигация ====
  document.getElementById('backBtn').addEventListener('click', () => {
    if (current>1){ current--; renderSteps(); }
  });
  document.getElementById('nextBtn').addEventListener('click', () => {
    if (!validate(current)) return;
    if (current < pages.length){ current++; renderSteps(); }
    else submit();
  });
  tg.MainButton.onClick?.(submit);

  renderSteps();
})();
</script>
</body>
</html>
